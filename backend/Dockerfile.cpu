# 企业级 AI 数据预处理平台 - CPU 本地开发环境
#
# 构建方式:
#   docker buildx build --platform linux/amd64 -t tianshu-backend-cpu:latest -f backend/Dockerfile.cpu .
#
# 运行方式:
#   docker run -p 8000:8000 tianshu-backend-cpu:latest
#
# 说明:
#   - 使用 linux/amd64 平台（Mac Apple Silicon 通过 Rosetta 2 模拟）
#   - CPU-only 依赖（无 CUDA）
#   - 适合本地开发调试，不适合生产环境

# ============================================================================
# Stage 1: Base Image (CPU-only, no CUDA)
# ============================================================================
FROM python:3.12-slim-bookworm AS base

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_CACHE_DIR=/root/.cache/pip

# 安装系统依赖（与 GPU 版本相同，但无 CUDA）
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-dev \
    git \
    wget \
    curl \
    libgomp1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgl1 \
    libgstreamer1.0-0 \
    ffmpeg \
    antiword \
    pandoc \
    && rm -rf /var/lib/apt/lists/*

# 安装 LibreOffice (固定大版本,确保构建可重现)
RUN apt-get update && \
    echo "Available LibreOffice versions:" && \
    apt-cache policy libreoffice | head -20 && \
    apt-get install -y --no-install-recommends \
    libreoffice \
    libreoffice-writer \
    libreoffice-calc \
    libreoffice-impress \
    && echo "Installed LibreOffice version:" && \
    libreoffice --version \
    && rm -rf /var/lib/apt/lists/*

# 升级 pip（使用国内镜像源，增加超时时间）
RUN --mount=type=cache,target=/root/.cache/pip \
    python3 -m pip install --upgrade pip setuptools wheel \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=300

# ============================================================================
# Stage 2: Dependencies Installation (CPU-only)
# ============================================================================
FROM base AS dependencies

WORKDIR /tmp

# 复制 requirements.txt
COPY backend/requirements.txt /tmp/requirements.txt

# 分步安装依赖（CPU 版本）
# Step 1: 安装 PaddlePaddle CPU 版本
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install paddlepaddle==3.2.0 \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=600 \
    --retries 5

# Step 2: 安装 PyTorch CPU 版本 (包含 torchaudio for SenseVoice/FunASR)
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 \
    --index-url https://download.pytorch.org/whl/cpu \
    --default-timeout=600 \
    --retries 5

# Step 3: 预先安装 Python 3.12 关键依赖
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install "kiwisolver>=1.4.5" "Pillow>=11.0.0" \
    "numpy>=1.26.0,<2.0.0" "setuptools>=75.0.0" "lxml>=5.3.0" \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=300 \
    --retries 5

# Step 3.5: 安装 transformers 核心依赖（regex、huggingface-hub 等）
RUN --mount=type=cache,target=/root/.cache/pip \
    echo "Installing transformers dependencies..." && \
    pip install regex packaging filelock requests tqdm \
    "huggingface-hub>=0.23.2,<1.0" \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=300 \
    --retries 5

# Step 4: 安装 MinerU 及其依赖（允许自动解析依赖）
RUN --mount=type=cache,target=/root/.cache/pip \
    echo "Installing MinerU with dependencies..." && \
    pip install mineru[core] \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=600 \
    --retries 5

# Step 4.5: 安装其他核心包
RUN --mount=type=cache,target=/root/.cache/pip \
    echo "Installing other core packages..." && \
    pip install paddleocr[doc-parser] \
    transformers==4.46.3 tokenizers==0.20.3 \
    fastapi uvicorn litserve aiohttp \
    PyMuPDF Pillow img2pdf einops easydict addict loguru modelscope \
    minio markitdown \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=300 \
    --retries 5

# Step 5: 确保 albumentations 版本兼容（MinerU 2.6.2 需要 1.3.x）
RUN --mount=type=cache,target=/root/.cache/pip \
    echo "Ensuring albumentations compatibility..." && \
    pip install 'albumentations>=1.3.1,<1.4.0' 'albucore>=0.0.13,<0.0.17' \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --default-timeout=300 \
    --retries 5

# Step 6: 解析剩余依赖（使用 legacy resolver，避免回溯超时）
RUN --mount=type=cache,target=/root/.cache/pip \
    echo "Resolving remaining dependencies with legacy resolver..." && \
    pip install -r /tmp/requirements.txt \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --use-deprecated=legacy-resolver \
    --default-timeout=600 \
    --retries 5

# 验证安装（CPU 模式）
RUN python -c "import sys; print('Python:', sys.version)" && \
    python -c "import torch; print('✅ PyTorch:', torch.__version__, '| CPU-only:', not torch.cuda.is_available())" && \
    python -c "import transformers; print('✅ Transformers:', transformers.__version__)" && \
    python -c "import funasr; print('✅ FunASR:', funasr.__version__)" && \
    echo "✅ CPU 模式依赖安装完成"

# ============================================================================
# Stage 3: Application
# ============================================================================
FROM dependencies AS application

# 创建应用目录
WORKDIR /app

# 复制后端代码
COPY backend/ /app/backend/
COPY pyproject.toml /app/

# 复制启动脚本
COPY scripts/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY scripts/init-models.sh /usr/local/bin/init-models.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh /usr/local/bin/init-models.sh

# 创建必要的目录
RUN mkdir -p /app/models /app/data /app/uploads /app/output /app/logs

# 设置工作目录为后端
WORKDIR /app/backend

# 暴露端口
# 8000: API Server
# 8001: LitServe Worker
# 8002: MCP Server
EXPOSE 8000 8001 8002

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 使用 entrypoint 脚本
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# 默认启动 API Server
# 第一个参数是服务类型（api/worker/mcp），用于 entrypoint 判断
CMD ["api", "python", "api_server.py"]
